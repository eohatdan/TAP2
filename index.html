<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TAP2 â€¢ RAG Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#0b1220; --muted:#5c697a; --bg:#f8fafc; --card:#ffffff; --accent:#2563eb; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { padding:16px 20px; background:var(--card); border-bottom:1px solid #e5e7eb; display:flex; gap:12px; align-items:center; justify-content:space-between; }
    header h1 { margin:0; font-size:16px; }
    .container { max-width:980px; margin:24px auto; padding:0 16px 48px; display:grid; gap:16px; }
    .card { background:var(--card); border:1px solid #e5e7eb; border-radius:10px; padding:16px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    label { font-weight:600; font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input[type=text], textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff; color:var(--fg); }
    textarea { min-height:96px; resize:vertical; }
    button { appearance:none; border:1px solid transparent; border-radius:8px; padding:10px 14px; background:var(--accent); color:#fff; cursor:pointer; font-weight:600; }
    button.secondary { background:#fff; color:var(--accent); border-color:var(--accent); }
    pre { background:#0b1220; color:#e5e7eb; padding:12px; border-radius:10px; overflow:auto; max-height:420px; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#6b7280; }
    .grid-2 { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 880px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
  </style>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ”Ž%3C/text%3E%3C/svg%3E">
</head>
<body>
  <header>
    <h1>TAP2 â€¢ RAG Console</h1>
    <small class="mono" id="version"></small>
  </header>

  <div class="container">

    <!-- Backend config -->
    <div class="card">
      <label for="backendUrl">Backend URL</label>
      <div class="row">
        <input type="text" id="backendUrl" value="https://tap2-backend.onrender.com" />
        <button class="secondary" onclick="pingBackend()">Ping</button>
        <button class="secondary" onclick="whichLLM()">Which LLM?</button>
      </div>
      <small class="mono">No trailing slash. Must match your Render backend origin.</small>
    </div>

    <div class="grid-2">
      <!-- Bulk load Gist -->
      <div class="card">
        <label for="gistId">Bulk Load Gist â€¢ Accepts ID or full Gist URL</label>
        <div class="row">
          <input type="text" id="gistId" placeholder="e.g. https://gist.github.com/user/e8a9d49523fc66c200ccd761bd1f82a5" />
          <button onclick="bulkLoadGist()">Bulk Load</button>
        </div>
        <small class="mono">We POST to <code>/bulk-load-gist?gist_id=â€¦</code> with <code>mode:'cors'</code> and no body.</small>
      </div>

      <!-- Ask a question -->
      <div class="card">
        <label for="question">Ask a Question</label>
        <div class="row">
          <input type="text" id="question" placeholder="e.g. who is thomas clarkeâ€™s father?" />
          <button onclick="askQuestion()">Ask</button>
        </div>
        <small class="mono">Sends JSON to <code>/query</code> with <code>{ query, limit }</code>.</small>
      </div>
    </div>

    <!-- Results -->
    <div class="card">
      <label>Results</label>
      <pre id="results">// results will appear here</pre>
    </div>

  </div>

  <script>
    // ---------- helpers ----------
    function backend() {
      const v = document.getElementById("backendUrl")?.value?.trim() || "";
      return v.replace(/\/+$/, ""); // strip trailing slash
    }

    function outBox() {
      let el = document.getElementById("results");
      if (!el) {
        el = document.createElement("pre");
        el.id = "results";
        document.body.appendChild(el);
      }
      return el;
    }

    function show(obj) {
      const el = outBox();
      if (typeof obj === "string") {
        el.textContent = obj;
      } else {
        el.textContent = JSON.stringify(obj, null, 2);
      }
    }

    // Accept bare IDs, full Gist URLs, or IDs with suffixes like *_FAMILY_LETTERS
    function normalizeGistId(raw) {
      const m = String(raw || "").match(/[a-f0-9]{32}/i);
      return m ? m[0] : "";
    }

    async function fetchJSON(url, init) {
      const res = await fetch(url, init);
      const text = await res.text(); // robust to non-JSON errors
      try {
        const data = JSON.parse(text);
        return { ok: res.ok, status: res.status, data, raw: text };
      } catch {
        return { ok: res.ok, status: res.status, data: { body: text }, raw: text };
      }
    }

    // ---------- actions ----------
    async function pingBackend() {
      try {
        const url = backend() + "/health";
        const { ok, status, data } = await fetchJSON(url);
        show({ url, ok, status, data });
      } catch (e) {
        show("Ping failed: " + e);
      }
    }

    async function whichLLM() {
      try {
        const url = backend() + "/which-llm";
        const { ok, status, data } = await fetchJSON(url);
        show({ url, ok, status, data });
        document.getElementById("version").textContent = `LLM: ${data?.preferred || "n/a"}`;
      } catch (e) {
        show("Error: " + e);
      }
    }

    async function bulkLoadGist() {
      const raw = document.getElementById("gistId")?.value || "";
      const gistId = normalizeGistId(raw.trim());

      if (!gistId) {
        show("Error: Please enter a valid 32-char Gist ID or a full Gist URL containing it.");
        return;
      }

      const url = backend() + "/bulk-load-gist?gist_id=" + encodeURIComponent(gistId);

      try {
        const { ok, status, data } = await fetchJSON(url, {
          method: "POST",
          mode: "cors" // no body, no Content-Type
        });
        show({ ok, status, data });
      } catch (e) {
        show("Network error during bulk load: " + e);
      }
    }

    async function askQuestion() {
      const q = document.getElementById("question")?.value?.trim();
      if (!q) { show("Enter a question."); return; }

      const url = backend() + "/query";
      const body = JSON.stringify({ query: q, limit: 5 });

      try {
        const { ok, status, data } = await fetchJSON(url, {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "application/json" },
          body
        });
        show({ ok, status, data });
      } catch (e) {
        show("Network error during query: " + e);
      }
    }

    // set version label on load (non-blocking)
    (async () => {
      try {
        const url = backend() + "/openapi.json";
        const r = await fetch(url);
        if (r.ok) {
          const j = await r.json();
          document.getElementById("version").textContent =
            `API v${j?.info?.version || "?"}`;
        }
      } catch (_) {}
    })();
  </script>
</body>
</html>
